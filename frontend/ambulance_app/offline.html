<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Mode - Ambulance Driver App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .container {
            padding: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .offline-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #7f8c8d;
        }
        
        .message {
            margin-bottom: 20px;
            color: #34495e;
        }
        
        .emergency-info {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: left;
        }
        
        .emergency-info h3 {
            margin-top: 0;
            color: #e74c3c;
        }
        
        .info-row {
            margin-bottom: 10px;
        }
        
        .label {
            font-weight: bold;
            display: inline-block;
            width: 100px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .footer {
            background-color: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }
        
        #offlineMap {
            width: 100%;
            height: 200px;
            background-color: #ddd;
            margin-top: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            background-image: url('images/offline-map.png');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Ambulance Driver App</h1>
        <div>Offline Mode</div>
    </div>
    
    <div class="container">
        <div class="offline-icon">ðŸ“¶</div>
        <h2>You are currently offline</h2>
        <p class="message">Your internet connection is unavailable. The app will continue to function with limited capabilities.</p>
        
        <div id="currentEmergency" class="emergency-info" style="display: none;">
            <h3>Current Emergency Assignment</h3>
            <div class="info-row">
                <span class="label">Location:</span>
                <span id="emergencyLocation">Not available</span>
            </div>
            <div class="info-row">
                <span class="label">Address:</span>
                <span id="emergencyAddress">Not available</span>
            </div>
            <div class="info-row">
                <span class="label">Caller:</span>
                <span id="emergencyCaller">Not available</span>
            </div>
            <div class="info-row">
                <span class="label">Status:</span>
                <span id="emergencyStatus">Not available</span>
            </div>
            
            <div id="offlineMap">
                <span>Cached map unavailable</span>
            </div>
        </div>
        
        <div id="noEmergency" class="emergency-info">
            <h3>No Active Emergency</h3>
            <p>You don't have any active emergency assignments.</p>
        </div>
        
        <button id="retryBtn" class="btn">Retry Connection</button>
    </div>
    
    <div class="footer">
        Emergency Response System - Offline Capabilities
    </div>

    <script>
        // Try to load emergency data from cache when offline
        document.addEventListener('DOMContentLoaded', async () => {
            const currentEmergency = document.getElementById('currentEmergency');
            const noEmergency = document.getElementById('noEmergency');
            const retryBtn = document.getElementById('retryBtn');
            
            // Try to load cached emergency data
            let emergencyData = null;
            
            try {
                // Try to get from cache
                const cache = await caches.open('ers-ambulance-app-v1');
                const response = await cache.match('/api/ambulance/cached-assignment');
                
                if (response) {
                    const data = await response.json();
                    if (data.success && data.has_assignment) {
                        emergencyData = data.emergency_call;
                    }
                }
            } catch (error) {
                console.error('Error loading cached emergency data:', error);
            }
            
            // If we have emergency data, display it
            if (emergencyData) {
                document.getElementById('emergencyLocation').textContent = 
                    emergencyData.latitude && emergencyData.longitude 
                        ? `${emergencyData.latitude}, ${emergencyData.longitude}` 
                        : 'Not available';
                
                document.getElementById('emergencyAddress').textContent = 
                    emergencyData.address || 'Address not available';
                
                document.getElementById('emergencyCaller').textContent = 
                    emergencyData.caller_phone || 'Not available';
                
                document.getElementById('emergencyStatus').textContent = 
                    formatStatus(emergencyData.status);
                
                // Show emergency info
                currentEmergency.style.display = 'block';
                noEmergency.style.display = 'none';
            }
            
            // Format status helper
            function formatStatus(status) {
                switch(status) {
                    case 'initiated': return 'Initiated';
                    case 'location_shared': return 'Location Shared';
                    case 'assigned': return 'Ambulance Assigned';
                    case 'arrived': return 'Ambulance Arrived';
                    case 'completed': return 'Completed';
                    default: return status || 'Unknown';
                }
            }
            
            // Retry connection
            retryBtn.addEventListener('click', () => {
                window.location.reload();
            });
        });
    </script>
</body>
</html>